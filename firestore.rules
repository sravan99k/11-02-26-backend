rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for tenant validation
    function isAuthenticated() {
      return request.auth != null && request.auth.token.email_verified == true;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.role == 'superAdmin';
    }
    
    function isOrgAdmin() {
      return isAuthenticated() && request.auth.token.role == 'orgAdmin';
    }
    
    function isSchoolAdmin() {
      return isAuthenticated() && request.auth.token.role == 'schoolAdmin';
    }
    
    function isTeacher() {
      return isAuthenticated() && request.auth.token.role == 'teacher';
    }
    
    function isStudent() {
      return isAuthenticated() && request.auth.token.role == 'student';
    }
    
    function userOrganizationId() {
      return request.auth.token.organizationId;
    }
    
    function userSchoolId() {
      return request.auth.token.schoolId;
    }
    
    function belongsToOrganization(orgId) {
      return isSuperAdmin() || userOrganizationId() == orgId;
    }
    
    function belongsToSchool(schoolId) {
      return isSuperAdmin() || isOrgAdmin() || userSchoolId() == schoolId;
    }
    
    // USERS COLLECTION - STRICT TENANT ISOLATION
    match /users/{userId} {
      // Super admins can read all users
      allow read, write: if isSuperAdmin();
      
      // Org admins can only access users in their organization
      allow read, write: if isOrgAdmin() && belongsToOrganization(resource.data.organizationId);
      
      // School admins can only access users in their school
      allow read, write: if isSchoolAdmin() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Teachers can only read users in their school
      allow read: if isTeacher() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Users can only access their own profile
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ORGANIZATIONS COLLECTION
    match /organizations/{organizationId} {
      // Super admins can access all organizations
      allow read, write: if isSuperAdmin();
      
      // Org admins can access their organization
      allow read, write: if isOrgAdmin() && userOrganizationId() == organizationId;
      
      // School admins can read their organization
      allow read: if isSchoolAdmin() && belongsToOrganization(organizationId);
      
      // Teachers and students can read their organization
      allow read: if (isTeacher() || isStudent()) && belongsToOrganization(organizationId);
    }
    
    // SCHOOLS COLLECTION
    match /organizations/{organizationId}/schools/{schoolId} {
      // Super admins can access all schools
      allow read, write: if isSuperAdmin();
      
      // Org admins can access schools in their organization
      allow read, write: if isOrgAdmin() && belongsToOrganization(organizationId);
      
      // School admins can access their school
      allow read, write: if isSchoolAdmin() && userSchoolId() == schoolId;
      
      // Teachers and students can read their school
      allow read: if (isTeacher() || isStudent()) && userSchoolId() == schoolId;
    }
    
    // TENANT-ISOLATED COLLECTIONS
    match /organizations/{organizationId}/schools/{schoolId}/{document=**} {
      // Super admins can access all tenant data
      allow read, write: if isSuperAdmin();
      
      // Org admins can access data in their organization
      allow read, write: if isOrgAdmin() && belongsToOrganization(organizationId);
      
      // School admins can access data in their school
      allow read, write: if isSchoolAdmin() && belongsToSchool(schoolId) && belongsToOrganization(organizationId);
      
      // Teachers and students can access data in their school
      allow read, write: if (isTeacher() || isStudent()) && belongsToSchool(schoolId) && belongsToOrganization(organizationId);
    }
    
    // INDEPENDENT SCHOOLS (NO ORGANIZATION)
    match /schools/{schoolId}/{document=**} {
      // Super admins can access all independent schools
      allow read, write: if isSuperAdmin();
      
      // School admins can access their independent school
      allow read, write: if isSchoolAdmin() && userSchoolId() == schoolId;
      
      // Teachers and students can access their independent school
      allow read, write: if (isTeacher() || isStudent()) && userSchoolId() == schoolId;
    }
    
    // PLATFORM-LEVEL COLLECTIONS (SUPER ADMIN ONLY)
    match /platform/{document=**} {
      allow read, write: if isSuperAdmin();
    }
    
    // BLOCK ALL ROOT-LEVEL BUSINESS COLLECTIONS
    match /mood_entries/{doc} {
      allow read, write: if false;
    }
    
    match /assessments/{doc} {
      allow read, write: if false;
    }
    
    match /chat/{doc} {
      allow read, write: if false;
    }
    
    match /analytics/{doc} {
      allow read, write: if false;
    }
    
    match /reports/{doc} {
      allow read, write: if false;
    }
    
    match /notifications/{doc} {
      allow read, write: if false;
    }
    
    // DENY ALL OTHER ACCESS
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
