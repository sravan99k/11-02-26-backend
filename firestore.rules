rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for tenant validation
    function isAuthenticated() {
      return request.auth != null && request.auth.token.email_verified == true;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.role == 'superAdmin';
    }
    
    function isOrgAdmin() {
      return isAuthenticated() && request.auth.token.role == 'orgAdmin';
    }
    
    function isSchoolAdmin() {
      return isAuthenticated() && request.auth.token.role == 'schoolAdmin';
    }
    
    function isTeacher() {
      return isAuthenticated() && request.auth.token.role == 'teacher';
    }
    
    function isStudent() {
      return isAuthenticated() && request.auth.token.role == 'student';
    }
    
    function userOrganizationId() {
      return request.auth.token.organizationId;
    }
    
    function userSchoolId() {
      return request.auth.token.schoolId;
    }
    
    function belongsToOrganization(orgId) {
      return isSuperAdmin() || userOrganizationId() == orgId;
    }
    
    function belongsToSchool(schoolId) {
      return isSuperAdmin() || isOrgAdmin() || userSchoolId() == schoolId;
    }
    
    // USERS COLLECTION - STRICT TENANT ISOLATION
    match /users/{userId} {
      // Super admins can read all users
      allow read, write: if isSuperAdmin();
      
      // Org admins can only access users in their organization
      allow read, write: if isOrgAdmin() && belongsToOrganization(resource.data.organizationId);
      
      // School admins can only access users in their school
      allow read, write: if isSchoolAdmin() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Teachers can only read users in their school
      allow read: if isTeacher() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Users can only access their own profile
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ORGANIZATIONS COLLECTION
    match /organizations/{organizationId} {
      // Super admins can access all organizations
      allow read, write: if isSuperAdmin();
      
      // Org admins can access their organization
      allow read, write: if isOrgAdmin() && belongsToOrganization(organizationId);
      
      // School admins can read their organization
      allow read: if isSchoolAdmin() && belongsToOrganization(organizationId);
      
      // Teachers and students can read their organization
      allow read: if (isTeacher() || isStudent()) && belongsToOrganization(organizationId);
    }
    
    // SCHOOLS COLLECTION
    match /schools/{schoolId} {
      // Super admins can access all schools
      allow read, write: if isSuperAdmin();
      
      // Org admins can access schools in their organization
      allow read, write: if isOrgAdmin() && belongsToOrganization(resource.data.organizationId);
      
      // School admins can access their school
      allow read, write: if isSchoolAdmin() && belongsToSchool(schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Teachers and students can read their school
      allow read: if (isTeacher() || isStudent()) && belongsToSchool(schoolId) && belongsToOrganization(resource.data.organizationId);
    }
    
    // ASSESSMENTS COLLECTION - STRICT TENANT ISOLATION
    match /assessments/{assessmentId} {
      // Super admins can access all assessments
      allow read, write: if isSuperAdmin();
      
      // Org admins can access assessments in their organization
      allow read, write: if isOrgAdmin() && belongsToOrganization(resource.data.organizationId);
      
      // School admins can access assessments in their school
      allow read, write: if isSchoolAdmin() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Teachers can access assessments in their school
      allow read, write: if isTeacher() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Students can only read their own assessments
      allow read: if isStudent() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId) && resource.data.studentId == request.auth.uid;
    }
    
    // WELLNESS JOURNALS COLLECTION - STRICT TENANT ISOLATION
    match /wellnessJournals/{journalId} {
      // Super admins can access all journals
      allow read, write: if isSuperAdmin();
      
      // Org admins can access journals in their organization
      allow read: if isOrgAdmin() && belongsToOrganization(resource.data.organizationId);
      
      // School admins can access journals in their school
      allow read: if isSchoolAdmin() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Teachers can read journals of students in their school
      allow read: if isTeacher() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Students can access their own journals
      allow read, write: if isStudent() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId) && resource.data.studentId == request.auth.uid;
    }
    
    // CHAT MESSAGES COLLECTION - STRICT TENANT ISOLATION
    match /chatMessages/{messageId} {
      // Super admins can access all messages
      allow read, write: if isSuperAdmin();
      
      // Org admins can access messages in their organization
      allow read: if isOrgAdmin() && belongsToOrganization(resource.data.organizationId);
      
      // School admins can access messages in their school
      allow read: if isSchoolAdmin() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Teachers can access messages in their school
      allow read, write: if isTeacher() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Students can access messages in their school
      allow read, write: if isStudent() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
    }
    
    // ANALYTICS COLLECTION - STRICT TENANT ISOLATION
    match /analytics/{analyticsId} {
      // Super admins can access all analytics
      allow read, write: if isSuperAdmin();
      
      // Org admins can access analytics in their organization
      allow read, write: if isOrgAdmin() && belongsToOrganization(resource.data.organizationId);
      
      // School admins can access analytics in their school
      allow read, write: if isSchoolAdmin() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Teachers can read analytics for their school
      allow read: if isTeacher() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Students can only read their own analytics
      allow read: if isStudent() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId) && resource.data.studentId == request.auth.uid;
    }
    
    // NOTIFICATIONS COLLECTION - STRICT TENANT ISOLATION
    match /notifications/{notificationId} {
      // Super admins can access all notifications
      allow read, write: if isSuperAdmin();
      
      // Users can only access their own notifications
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // FILES COLLECTION - STRICT TENANT ISOLATION
    match /files/{fileId} {
      // Super admins can access all files
      allow read, write: if isSuperAdmin();
      
      // Org admins can access files in their organization
      allow read, write: if isOrgAdmin() && belongsToOrganization(resource.data.organizationId);
      
      // School admins can access files in their school
      allow read, write: if isSchoolAdmin() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Teachers can access files in their school
      allow read, write: if isTeacher() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
      
      // Students can access files in their school
      allow read: if isStudent() && belongsToSchool(resource.data.schoolId) && belongsToOrganization(resource.data.organizationId);
    }
    
    // DENY ALL OTHER ACCESS
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
